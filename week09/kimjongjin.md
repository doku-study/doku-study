# Docker & Container 시작하기

## 모듈 소개
쿠버네티스로 넘어가기 이전, 도커 핵심 개념 정리

- Docker 핵심 개념
- localhost 머신의 로컬환경에서 도커를 실행하는 방법+필요도구 및 작업
- 컨테이너 배포


## 이미지 & 컨테이너 
컨테이너
- 코드와 그 코드를 실행하는데 필요한 환경을 포함하는 박스
- 하나의 컨테이너는 하나의 작업(task)에 집중
  - 웹서버, 프론트엔드, 데이터베이스등을 하나의 컨테이너에 넣지 않음
- 공유 및 재생산이 용이한 패키지 구성
- Stateless
  - 기본적으로 컨테이너는 휘발성
  - 볼륨을 사용해서 로컬 호스트의 머신으로 데이터를 복사/미러링 가능

이미지
- 컨테이너 생성의 기반
- Dockerfile로 만들거나 Dockerhub에서 가져옴
- 이미지는 공유 가능하며, 이미지를 기반으로 다중 컨테이너 생성 가능


## 주요 명령 
`docker build`
- Dockerfile을 기반으로, 도커 이미지 생성
- 이미지에 이름과 태그를 사용하여 버전화 가능
  - `docker build -t NAME:TAG .`

`docker run`
- 이미지를 기반으로 컨테이너 생성
  - --name 옵션으로 컨테이너 이름 지정 가능
  - --rm 옵션으로 중지시 자동 제거
  - -d 옵션으로 detached 모드에서 실행 가능

`docker push/pull`
- 이미지 업로드/다운로드 옵션
- 기본적으로 Dockerhub를 활용하여 이미지 공유 수행


## 데이터, 볼륨 및 네트워킹
볼륨)   
컨테이너 종료시 데이터 유실 방지를 위해 필요
- 바인드 마운트
  - 호스트 머신의 특정 경로에 컨테이너 미러링
- 볼륨(익명볼륨/네임드볼륨)
  - 호스트 머신의 디렉토리로 미러링 되지만 위치는 알지못함(사실 알 순 있음)
  - 새로운 컨테이너 생성 등 재사용 가능한 볼륨

네트워크)
기본적으로 컨테이너는 독립된 실행환경. 상호 통신 불가
1. 컨테이너 IP를 조회해서 바로 사용
  - 불편하고 자주 사용되지않음
2. Docker network를 생성하여 연결
  - 통신하려는 컨테이너에 동일 네트워크를 연결
  - 컨테이너 이름을 통해 컨테이너 IP를 해결

## Docker Compose

Docker를 사용하다보면 실행 명령어 등이 길어지게 됨.     
ex) 환경변수, 볼륨, 네트워크, etc..     

Docker Compose를 사용해서 시작 구성을 구성파일로 정리 가능.
- 구성 파일에 정의된 컨테이너 서비스를 시작 및 초기화가능
  - docker compose up
  - docker compose down
\> 다중 컨테이너 관리 용이

## 로컬 vs 리모트
격리된 개발 환경을 위한 로컬 머신   
vs  
어플리케이션을 배포하려는 리모트 머신   

격리, 캡슐화, 재사용성이 높은 Docker 환경을 사용 중     
모든것은 컨테이너/기반 이미지에 있기 때문에 재현이 용이함       

업데이트
- 기존 소스의 컨테이너를 신규 소스의 컨테이너로 교체

어플리케이션을 배포하지 않는게 일반적이다 > 어떤맥락인지?

## Deployment
- 개발환경의 옵션들(바인드 마운트)과 운영환경의 옵션 분리(Dockerfile 내 COPY)
- 다중 컨테이너 환경시 단일머신(로컬 호스트)가 아니라 여러 호스트로 분리 될 수 있음

Multistage build > 컨테이너를 쉽게 배포할 수 있다? 

환경 통제(Control) vs 손쉬운 사용(Ease-of-use)
- 자체 VM인 EC2 기반에서 네트워크, 보안 설정등을 완벽히 통제
vs
- 관리형 서비스(ECS)를 기반으로 간편히 사용

# Kubernetes 시작하기

## 모듈 소개
Docker container 관리 및 배포하는 구체적인 방법 > Kubernetes

Kubernetes
- 중앙집중화된 대규모 컨테이너 오케스트레이션 플랫폼

- 컨테이너 배포 시 직면하는 문제점들
  - 쿠버네티스가 어떻게 문제를 해결하는지
- 쿠버네티스란 무엇인지/왜 사용하는지
  - 핵심 쿠버네티스 개념
  - 구성요소 파악

현재 모듈에서는 이론적인 부분을 학습할 예정,    
다음 모듈에서 실제로 작동하는 모습 확인,    
궁극적으로 CSP의 운영환경에서 배치하는 방법


## 수동 배포의 더 많은 문제점들
AWS EC2 기반의 운영의 경우
- 환경 구성 및 보안 외에도
- 컨테이너 충돌,다운 및 교체의 필요성
  - 발생시마다 수동 모니터링
  - 장애 이후 수동 컨테이너 재시작
  - 항상 수동으로 대기하고, 대응할 수 없음

항상 하나의 컨테이너만 대상으로 학습하였음 > Scaling의 부재
- 트래픽 급증 시 더 많은 컨테이너 태스크가 필요할 수 있음
- 컨테이너간 고르게 분산
- 트래픽 안정화 이후 컨테이너 제거


## 왜 Kubernetes 인가?
ECS를 사용하면서 일부 문제 해결이 되긴 하였음
- 컨테이너 상태 자동 확인 및 재시작
- Auto Scaling & Load Balancer > 고정된 IP/Domain 제공 및 트래픽 분할

단점
- 특정 CSP의 서비스를 사용하는 이상 그 벤더에 종속되기 마련
  - ECS의 작동 원리(클러스터,네임스페이스,태스트,태스트정의)는 AWS ECS에서만 사용 가능
- 타 CSP(Azure,GCP등)으로 이전해야 될 경우 문제가 될 수 있음

## Kubernetes가 정확히 무엇인가?
Kubernetes
- 오픈소스 시스템
- 컨테이너 배포 관리 및 오케스트레이션의 사실상 표준(de facto)
- 자동 배포, 스케일링, 로드 밸런싱, 모니터링, 재시작
- 쿠버네티스의 구성파일을 다른 CSP의 쿠버네티스 환경에서도 재사용 가능

Docker Compose 와의 차이점
- Docker Compose의 경우 단일 머신에서, 다중 컨테이너 환경 관리를 위해 사용
- Kubernetes의 경우 다중 머신에서, 다중 컨테이너 환경 관리를 위해 사용

## Kubernetes 아키텍처 & 핵심 개념
- Pod
  - k8s 생태계에서 가장 작은 작업 단위
  - 하나 이상의 컨테이너를 보유 가능
- Worker Node
  - 컨테이너를 실행하는 가상 머신
  - CPU/Memory가 있는 머신(ex. EC2)에 대응
- Proxy
  - 워커 노드의 컨테이너(파드)에 대한 네트워크 트래픽 제어
  - 어떻게 외부 트래픽이 워커노드를 거쳐, 컨테이너까지 도달할 수 있을 것인가?
- Control Plane
  - 실제 Workload를 담당하는 워커노드와 파드에 대한 제어 및 환경 분리
  - Master Node를 통해 구성된 Control Plane이 k8s 플랫폼 제어
  - 대규모 환경에서는 고가용성 보장을 위해 다수의 머신을 사용한 컨트롤플레인을 구현하기도함

## Kubernetes는 인프라를 관리하지 않습니다!
Kubernetes will NOT manage your Infrastructure!

마치 EC2를 생성하고, Docker 설치 및 네트워크 구성을 한 뒤 컨테이너를 실행했던 것과 같이,    
Kubernetes 또한 마스터/워커노드를 통해 k8s클러스터 구성 이후 컨테이너 실행 및 관리를 수행함.

이때 마스터/워커노드 같은 인프라 영역은 쿠버네티스가 관리하지 않음.     
생성된 인프라 기반으로 작동하기만 할 뿐임.  

## 워커 노드 자세히 살펴 보기
워커 노드 또한 CPU/Memory/Disk를 가진 별도의 머신임.      
하나 이상의 컨테이너를 가진 Pod가 워커노드에서 호스팅 됨.   

따라서 특정 pod(컨테이너)가 생성/제거될 시 워커노드의 리소스를 갖고 실행됨. 

다른 워커노드/마스터 노드와의 통신은 kubelet이라는 별도 소프트웨어에서 처리

## 마스터 노드 자세히 살펴 보기
마스터 노드 또한 CPU/Memory/Disk를 가진 별도의 머신임.      
하나 이상의 컨테이너를 가진 Pod가 마스터 노드에서 호스팅 됨.   

그러면 워커노드랑은 어떤 차이가 있느냐?     
\> 워커 노드에서는 실제 트래픽(Workload)를 처리하기 위한 Pod 배치
\> 마스터 노드에서는 클러스터 제어를 위한 Pod의 배치

API-server
- 전체 클러스터 명령 제어

Scheduler
- 새로운 Pod 생성시, 배치될 노드를 결정

Controllers
- 클러스터 환경을 감시하고, 적절한 상태가 유지되도록 제어
  - Pod 숫자등 다양한 컨트롤러가있음

ETCD
- 엥 이게없다니
- 클러스터 상태를 저장하는 K-V 저장소

![k8s archi](https://www.simform.com/wp-content/uploads/2023/08/Kubernetes-Architecture-Diagram.jpg)
![무서운 그림](https://media.licdn.com/dms/image/D4E22AQF6-Ws-cZCifA/feedshare-shrink_2048_1536/0/1689926162631?e=1710979200&v=beta&t=OOkCD7NPx7oLFHf6lFqz6xygioJ_AKGpUQRS98hF7Zo)


## 중요 용어 & 개념

클러스터(Cluster)
- 워커/마스터 노드로 구성되어 배포 혹은 최종 상태를 구현하는 모든 구성요소의 집합

노드(Node)
- 하나 이상의 Pod를 호스팅
- 실제 CPU/Mem/DISK를 가진 머신
- 역할에 따라 마스터노드/워커노드로 구분

파드(Pod)
- 컨테이너를 포함하는, k8s의 제일 작은 구성요소

컨테이너(Container)
- 일반적인 Docker 컨테이너
- docker run 명령어로 실행했던 그거

서비스(Service)
- 파드/컨테이너 외에 독립적인 IP주소를 가진 파드그룹
- 파드 접근시 중요하게 사용되며, 프록시 개념과도 연관되어있음

### 이야깃거리
- 쿠버네티스를 왜쓰나요         
https://kubernetes.io/ko/docs/concepts/overview/#why-you-need-kubernetes-and-what-can-it-do

이런 질문을 많이 받곤 하는데, 결국 최선의 답은 공식문서에서 제공하는 쿠버네티스의 특징으로 수렴한다고 생각합니다.   
전반적으로 자동화된 운영관리에 포커스가 맞춰져있고, 앞으로의 강의에서 어떻게 자동화한된 운영이 가능한지 살펴볼 수 있으면 좋겠네요.  

\+ 추가적으로는      
https://landscape.cncf.io/      
https://yozm.wishket.com/magazine/detail/2371/      
오픈소스 기반이다보니, 넓은 오픈소스 생태계가 구성되어있어      
CICD/모니터링/네트워크/스토리지 등 다양한 영역에서 활용할 수 있는 도구가 많다 정도?


- kubernetes 아키텍처 설명
https://youtu.be/8C_SCDbUJTg?si=NHq9edmxYC2t-XHN

Kubernetes 자격증인 CKA등을 준비할때 많이들 듣는 [Udemy의 뭄샤드 강의](https://www.udemy.com/course/certified-kubernetes-administrator-with-practice-tests/)에 있는 내용입니다.     
디테일한 설명 자료는 많은데, 처음 간단하게 개념잡을때는 배를 통한 비유가 이해하기 좋았네요