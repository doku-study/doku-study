## 컨테이너를 다루는 개발환경과 프로덕션 환경의 차이

|                        | Development                                                  | Production                                                   |
| ---------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 코드 캡슐화            | 컨테이너는 런타임 환경을 캡슐화하고 있어야 하지만, 코드를 캡슐화할 필요는 없음. | 이미지와 컨테이너는 Single Source Of Truth, 즉 컨테이너 안에 애플리케이션을 실행하는 데에 필요한 모든 것 (코드 포함) 이 캡슐화 되어있어야 함. |
| 바인드 마운트 활용     | 바인드 마운트를 활용하여 실행중인 컨테이너에 로컬 호스트의 코드 변경 사항을 반영할 수 있음. | 빌드할 때 바인드 마운트 대신 COPY 명령어를 사용함. 따라서 빌드된 이미지에 소스 코드를 포함하여 애플리케이션을 실행하는 데에 필요한 모든 것이 함께 빌드됨. |
| 컨테이너와 호스트 싱크 | 컨테이너를 재시작하지 않고도 변경사항이 즉각 반영되도록 할 수 있음. | 이미지 안에 애플리케이션을 실행하는 데에 필요한 모든 것이 캡슐화 되어 있으므로, 해당 이미지나 컨테이너를 어느 곳에서든, 어떤 추가 설정이나 코드 없이도 실행했을 때에 같은 결과를 보장함. |



<br />

## EC2 를 활용하여 컨테이너를 배포하는 방법 요약과 단점



컨테이너 배포 방법

* 로컬에서 도커 이미지 빌드
* 로컬에서 도커 허브에 빌드한 이미지 push
* AWS EC2 에서 인스턴스 생성
* 생성한 인스턴스에서 이미지 pull 및 run



해당 방법의 단점

* EC2 수동 생성
* EC2 수동 구성
* 수동 연결
* 도커 수동 설치
* essential SW, network, securiryGroups, firewall, ... 직접관리
* SSH 를 통해 접근하는 것 귀찮음



control과 responsibility 사이의 trade-off 에 대해 생각해보자.

이러한 단점들을 보완해줄 ECS 에 대해 알아보자.

<br />

## ECS 를 활용하여 컨테이너 배포



EC2 대신 ECS 를 활용하면 다음과 같은 장점들이 있다.

* 생성, 관리, 업데이트가 자동으로 이뤄짐
* 모니터링과 스케일링이 단순함

단순히 앱/컨테이너의 배포만이 목적이라면 ECS 를 쓰는쪽이 편하다.



<br />

## ECS 와 Task

ECS 는 EC2 와 달리 무료가 아니다. 

Task 는 하나의 애플리케이션으로 함께 실행되는 컨테이너 모음.

Default Task 는 FARGATE 라는 것으로 되어있으며, 애플리케이션에서 요청하는 vCPU, 메모리 리소스 양에 대해서 요금이 부과된다.

FARGATE 는 필요할 때에만 서버가 생성된다는 장점이 있다.

Task 로 FARGATE 대신 EC2 를 사용하도록 설정할 수도 있다.



<br />

## Cluster

서비스가 실행되는 전체 네트워크

다중 컨테이너 애플리케이션을 배포하려는 경우, 하나의 클러스터에 여러 컨테이너를 함께 두면, 논리적으로 함께 속하게 되어 서로 통신할 수 있다.



<br />

## ECS 에 내 애플리케이션 컨테이너의 변동사항 알리기

코드를 수정한 뒤 컨테이너를 다시 도커 허브에 올린다고 ECS 에 배포되어 있는 컨테이너도 자동으로 업데이트 되는 것은 아니다.

업데이트 하는 방법은 두 가지가 있다.

* 새로운 Task 를 만들기
* 기존 서비스를 업데이트 -> 새 버전 배포하기 (Force new deployment)



AWS 는 구동되는 모든 새 Task 에 대해 새로운 public IP 를 할당하므로 주의하자.



<br />

## 리모트 환경에서의 Docker-compose 의 효용

 Docker-compose 는 리모트 환경에서는 잘 쓰이지 않고, 로컬 환경에서 다중 컨테이너를 구축할 때 주로 쓰인다.

리모트 환경에서 잘 쓰이지 않는 이유는, 클라우드에서는 여러 컨테이너를 실행하기 위해 여러 대의 머신이 동시에 동작한다. 모든 컨테이너를 하나의 머신에서 실행했던 로컬 환경과는 달리...



<br />



## 리모트 환경에서의 Docker network 의 효용

리모트 환경에서는 컨테이너가 항상 동일한 머신에서 실행되리란 보장이 없기 때문에, docker network 의 접근 방식 역시 더이상 동작하지 않는다.

```javascript
mongoose.connect(
  `mongodb://......@mongodb:27017/course-goals?authSource=admin`)
```



그러나 AWS ECS 의 경우는 동일한 태스크에 컨테이너를 추가하면, 동일한 머신에서의 실행이 보장된다.

그래도 여전히 도커 네트워크를 통한 것은 아니고, localhost 를 컨테이너 애플리케이션 코드 내부의 주소로 사용할 수 있게 해준다.

따라서 AWS ECS 를 배포할 때에는, 소스코드에서 mongodb (컨테이너 이름) 이 적힌 부분에 다른 값( ECS  localhost )이 들어올 수 있게 열어둬야 한다.



```javascript
mongoose.connect(
  `mongodb://......@${process.env.MONGODB_URL}:27017/course-goals?authSource=admin`)
```





