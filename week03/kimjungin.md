# 데이터관리 및 볼륨으로 작업하기



### 데이터의 종류

- 도커 이미지 (코드)
    - 이미지를 빌드할 때 코드가 이미지에 복사됩니다. 이미지가 복사되면 코드는 고정됩니다.
    - 이미지는 읽기 전용이기 때문에 실행 중 코드는 변하면 안됩니다. (불변)


- 임시데이터
    - 사용자가 들어와 입력한 데이터


- 영구 데이터
    - ex) 사용자 회원 정보 데이터
    - 영구 데이터는 파일이나 데이터베이스에 저장된다.
    - container 의 stop 이나 restart 로 인해 데이터가 소실되면 안된다.
    - conatiner 나 volume 에 저장된다.


<br />

### 도커의 데이터 쓰는 방식

- 이미지가 아닌 컨테이너에 저장된다는 것은 부가(extra) 레이어에 대해 이야기하는 것
- 이 레이어는 실제 컨테이너를 구성합니다.
- 이미지의 파일 시스템을 인식하며, 복사하지 않고 파일을 미러링하는 로직입니다.
- 도커는 read-write 권한을 가지며, 파일의 시스템을 조작할 수 있습니다.
- 이미지 자체는 변경하지 않은 채 부가레이어에서 변경합니다.
- 도커는 컨테이너의 변경 사항을 추적하고, 이미지와 파일 시스템을 가져와 최종 파일 시스템을 파생시켜 read-write 레이어에 저장된 변경 사항과 결합시킵니다.
- 컨테이너 내부에 쓰여진 데이터는 컨테이너 자체가 삭제되지 않는 이상 컨테이너에 유지된다.

### 볼륨이란?

- 호스트 머신의 폴더, 호스트 컴퓨터에 장착된 하드 드라이브에 존재하며, 컨테이너로 매핑된 것을 의미


- COPY
    - 실제로 복사하도록 명령한 스냅샷을 가져와 파일과 폴더를 이미지에 복사하는 것이 전부
    - 지속적인 관계나 연결이 없으며, 이미지에 복사되는 일회성 스냅샷일 뿐


- 볼륨
    - 컨테이너 내부의 폴더를 호스트 머신 상의 컨테이너 외부 폴더에 연결할 수 있음
    - 두 폴더의 변경 사항은 동기화됨
    - 볼륨은 컨테이너가 종료된 경우에도 지속되며 계속 존재함


### 볼륨을 설정하는 방법

- Dockerfile 에 VOLUME 명령어를 추가하는 방법
    - 익명 볼륨과 명명 볼륨
        - 익명 : `docker run -v /app/data busybox`
        - 명명 : `docker volume create my-named-volume` ,  `docker run -v my-named-volume:/app/data busybox`
        - 차이
            - 생성방법 : 익명 볼륨은 컨테이너 실행 시 자동으로 생성, 명명 볼륨은 명령어를 통해서만 생성
            - 이름 지정 : 익명 볼륨은 컨테이너 종속적이며, 이름이 없음, 명명 볼륨은 다른 컨테이너에서도 동시에 사용 가능
            - 수명 : 익명 볼륨은 컨테이너의 수명과 일치하며, 컨테이너 삭제 시 삭제됨. 명명 보륨은 명시적으로 삭제하지 않는 한 계속해서 존재
                - 그러나 익명 볼륨은 `--rm` 옵션이 없다면 자동으로 제거 되지 않음
    - 컨테이너 내부 경로와 마운트하고자 하는 외부 경로를 명시해야 한다.


- 도커에는 실제로 여러 가지의 외부 데이터 저장 메커니즘이 존재함.
    - 볼륨
    - 바인드 마운트


```jsx
# docker volume 삭제
docker volume rm {volume_name}

# 사용하지 않는 볼륨 제거
docker volume prune
```

### 바인드 마운트

- 우리는 도커에 의해 관리되는 볼륨의 위치는 실제 알지 못한다.
- 바인드 마운트의 경우에는 알 수 있다. 왜냐하면 호스트 머신 상 매핑될 컨테이너의 경로를 설정할 수 있기 때문이다.
- 바인드마운트는 그대로 폴더를 연결하기 때문에 영구적이고 편집 가능한 데이터에 적합하다.
- 명명된 볼륨은 영구 데이터에 도움이 되지만 편집은 실제로 불가능하기 때문이다.
- ***-v 로 선언할 때 : 앞에 로컬 머신 경로가 있으면 바인드 마운트, 볼륨 이름이 있으면 명명 볼륨으로 설정된다.***


### 읽기 전용 볼륨 마운트

- 디폴트로 볼륨은 read-write 이며, 이는 컨테이너가 볼륨에서 데이터를 읽고, 쓸 수 있음을 의미합니다.
- 컨테이너는 내부 경로 뒤에 콜론을 추가한 다음 readonly 를 의미하는 `ro` 를 추가하면 readonly 가 적용됩니다. (컨테이너만 적용)
- 호스트 머신에서는 파일을 읽고 쓸 수 있습니다.
- 도커파일에서 Volume 을 지정해도 `docker run` 명령어에서 명시된 Volumn 이 우선권을 가진다.

### 도커 볼륨 명령어

```jsx
# docker volume 관련 명령어
docker volume --help

# volume 목록
docker volume ls

# volume 생성
docker volume create
```

### 바운드 마운트와 COPY 의 차이점

- docker run 명령어는 보통 개발용으로 사용한다.
- COPY 는 스냅샷을 가질 수 있어 캐시가 가능하다.

### .dockerignore

- docker ignore 를 사용하면 COPY 명령어로 복사하지 못하게 할 수 있다.

### 인수와 환경변수

- docker build 를 실행할 때 `--build-arg` 옵션을 사용해서 함께 제공되는 인수를 활용할 수 있다.
- 환경변수는 arg 처럼 Dockerfile 내부에서 사용 가능하다.
- 인수는 실행 중인 애플리케이션의 전체 애플리케이션 코드에서 사용할 수 있다.
- 포트의 디폴트 값의 경우도 인수로 다룰 수 있음. (ARG)

