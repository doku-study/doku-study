# 3주차: 데이터 관리 및 볼륨으로 작업하기

### 데이터의 종류

- read-only: 이미지 레이어의 데이터. (코드, 실행 환경 등)
- short term: 컨테이너 레이어의 데이터. (사용자의 입력값 등)
  - 컨테이너 런타임에 생성
  - 메모리, 임시 파일 등에 저장
  - 컨테이너 종료 시 삭제됨.
- long term: 볼륨에 저장되는 데이터. (사용자 계정 데이터)
  - 컨테이너 런타임에 생성
  - 파일, DB에 저장
  - 컨테이너 종료 시에도 삭제되지 않음.

### 도커가 제공하는 Storage의 종류

- Volumes
  - Anonymous Volumes
  - Named Volumes
- Bind Mounts

## Volumes

- 호스트에 존재하는 폴더. 컨테이너 안의 폴더에 "마운트" 될 수 있다.
- 컨테이너는 볼륨에 접근하여 read/write 모두 가능.
- 도커가 관리하며, 호스트의 어느 경로에 위치하는지 사용자는 알 수 없으며 직접 접근하지 않도록 설계 되었다.

### 종류

- Anonymous Volumes: 컨테이너가 종료될 때 같이 사라짐.
  - 특정 컨테이너 전용으로 생성됨. 다른 컨테이너는 접근할 수 없다.
  - 도커 파일에서 생성할 수 있다.
- Named Volumes: 컨테이너가 종료되어도 계속 살아있음.
  - 도커 파일로 관리할 수 없다. 특정 컨테이너에 속하는게 아니기 때문.
  - 여러 컨테이너가 공유할 수 있다.

### 명령어

- 도커 파일에 입력하는 `COPY` 명령어는 호스트 파일의 스냅샷을 떠서 복붙하는 것. 볼륨과는 다름.

#### 익명 볼륨

- 도커 파일에서 `VOLUME` 을 사용하거나

```
VOLUME ["<컨테이너 내부 경로>"]
```

- 컨테이너 실행 시 아래 옵션을 준다.

```
-v <컨테이너 내부 경로>
```

#### Named 볼륨

- Named 볼륨을 사용하기 위해서는 컨테이너 실행 시 아래 옵션을 준다.
  - 도커 파일에서 설정할 수 없는 이유는 이미지가 아닌 컨테이너와 관련된 것이기 때문.

```
-v <볼륨명>:<컨테이너 내부 경로>
```

## Bind Mounts

- 호스트에 존재하는 폴더.
- 볼륨과는 다르게 호스트의 어느 경로에 위치할지 사용자가 지정할 수 있다.
- 특정 컨테이너와 엮이지 않는다. 여러 컨테이너가 공유할 수 있다.
- 컨테이너 이미지를 다시 빌드하지 않고도 컨테이너에 실시간으로 데이터를 제공하고 싶을 때 주로 사용.

### 명령어

- 컨테이너 실행 시 아래 옵션을 준다.
  - 역시나 이미지가 아닌 컨테이너와 관련된 것이기 때문에 도커파일에서 지정할 수 없다.

```
-v "<호스트 내부 경로(절대 경로)>:<컨테이너 내부 경로>"
```

- 이 때, 지정한 <컨테이너 내부 경로>로 <호스트 내부 경로>에 있는 모든 내용이 그냥 복사되는게 아니라 **덮어쓰기** 된다.
  - 예) 소스코드 변경사항을 바로 반영하고 싶어서 Bind Mounts를 사용해 노드 서버를 띄울 경우, 이미지 빌드 시 만들었던 node_modules 폴더가 프로젝트 폴더 내부에 있다면 컨테이너 실행 시 사라지게 된다.
    - 이를 막기 위해서 node_modules 폴더만 따로 빼는 방법을 쓸 수 있다.
    ```
    -v <...절대 경로...>:/app           --> Bind Mount: 프로젝트 폴더를 컨테이너 안의 /app 에 연결
    -v feedback:/app/feedback         --> 기명 볼륨: feedback 폴더를 컨테이너 안의 /app/feedback 에 연결
    -v /app/node_modules             --> 익명 볼륨: /app/node_modules 를 익명 볼륨에 저장
    ```
    - 위와 같이 -v 옵션을 여러개 썼을 때, 더 자세한 경로를 입력한 옵션이 우선순위가 높다.
      - 따라서 /app/feedback 은 feedback 이라는 이름을 갖는 기명 볼륨, /app/node_modules 는 익명 볼륨이 되고 나머지 내용물이 /app 경로로 들어갈 것이다.

## Volumes vs. Bind Mounts

Bind Mounts는 volumes에 비해 제한된 기능을 가진다. (https://docs.docker.com/storage/bind-mounts/)

- Volumes는 도커 CLI로 관리할 수 있으나 Bind Mounts는 그렇지 않다.
- Volumes는 여러 컨테이너 사이에서 좀 더 안전하게 공유될 수 있다.
- 맥, 윈도우 호스트에서 도커 데스크탑을 사용할 경우 Volumes 의 성능이 Bind Mounts 보다 높다.

---

## ARG 와 ENV

도커는 빌드 타임 arguments 와 런타임 environment variables 를 지원한다.

- ARG
  - 도커파일에서 사용 가능. 단, CMD 에서는 사용 불가. (런타임 시 실행되기 때문.)
  - 애플리케이션 코드에서는 인식 불가능
  - 이미지 빌드 시 `--build-arg` 로 전달
  ```
  // 도커 파일
  ARG DEFAULT_PORT=80
  ENV PORT $DEFAULT_PORT
  ```
  ```
  --build-arg DEFAULT_PORT=8000
  ```
- ENV

  - 도커파일에서 사용 가능
  - 애플리케이션 내부에서도 인식 가능
  - 도커 파일에서 `ENV`로 설정하거나 컨테이너 실행 시 `--env`나 `--env-file` 로 전달

  ```
  // 도커 파일
  ENV PORT 80
  EXPOSE $PORT
  ```

  ```
  --env PORT=8000
  --env-file ./.env
  ```
